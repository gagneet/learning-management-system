// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant support - Centers/Tenants
model Center {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  region      String?  // Region for multi-region support
  branding    Json?    // Branding settings (logo, colors, etc.)
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  courses     Course[]
  financialTransactions FinancialTransaction[]
  
  // Phase 1 relationships
  auditEvents     AuditEvent[]       @relation("AuditEvents")
  approvalRequests ApprovalRequest[] @relation("ApprovalRequests")
  classes         ClassCohort[]      @relation("Classes")
  tickets         Ticket[]           @relation("Tickets")
  slaConfigs      SLAConfig[]        @relation("SLAConfigs")
  feePlans        FeePlan[]          @relation("FeePlans")
  studentAccounts StudentAccount[]   @relation("StudentAccounts")
  invoices        Invoice[]          @relation("Invoices")

  // Phase 1: Individualized Tutoring Platform
  awards          Award[]            @relation("CentreAwards")
  sessionTemplates SessionTemplate[]  @relation("CentreTemplates")
  sessions        Session[]
  presenceLogs    SessionPresenceLog[]
  activityLogs    ActivityLog[]
  whiteboards     WhiteboardState[]
  studentSessionEnrollments StudentSessionEnrollment[]
  helpRequests    HelpRequest[]      @relation("CentreHelpRequests")
  
  // Phase 1: In-built video conferencing
  videoRecordings VideoRecording[]   @relation("CentreVideoRecordings")
}

// User model with role-based access
enum Role {
  SUPER_ADMIN      // Full system access across all centers
  CENTER_ADMIN     // Admin for a specific center
  CENTER_SUPERVISOR // Supervisor for a specific center
  FINANCE_ADMIN    // Financial administrator for a center
  TEACHER          // Teacher/Tutor role
  PARENT           // Parent/Guardian role
  STUDENT          // Student role
}

enum AgeTier {
  TIER1  // Ages 5-8 (playful, large touch targets)
  TIER2  // Ages 9-13 (structured, medium density)
  TIER3  // Ages 14+/Adult (professional, standard)
}

enum ThemePreference {
  LIGHT  // Light mode (white surfaces)
  GRAY   // Gray mode (soft gray surfaces)
  DARK   // Dark mode (dark surfaces)
}

enum SessionMode {
  ONLINE    // Online/virtual session
  PHYSICAL  // Physical/in-person session
  HYBRID    // Mixed: some students online, some physical
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String    // Hashed password
  role          Role      @default(STUDENT)
  avatar        String?
  bio           String?
  languagePreference String @default("en") // Language preference
  accessibilitySettings Json? // Accessibility settings (font size, contrast, etc.)
  specialNeeds  Json?     // Special needs indicators (Autism, ADHD, etc.)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NEW: Age-tier system (nullable with defaults)
  dateOfBirth       DateTime?
  ageTier           AgeTier   @default(TIER3)
  
  // NEW: Theme preference (nullable with default)
  themePreference   ThemePreference @default(LIGHT)

  // Multi-tenant relationship
  centerId      String
  center        Center    @relation(fields: [centerId], references: [id], onDelete: Cascade)
  
  // Teaching relationships
  taughtCourses Course[]  @relation("TeacherCourses")
  
  // Student relationships
  enrollments   Enrollment[]
  progress      Progress[]
  
  // Academic profile
  academicProfile AcademicProfile?
  
  // Gamification
  gamificationProfile GamificationProfile?
  xpTransactions    XPTransaction[]
  badgeAwards       BadgeAward[]
  streaks           Streak[]
  leaderboardOptIn  LeaderboardOptIn?

  // Financial transactions
  financialTransactions FinancialTransaction[]
  
  // Session attendance
  sessionAttendance SessionAttendance[]
  
  // NEW: Student session enrollments (for personalized session content)
  studentSessionEnrollments StudentSessionEnrollment[] @relation("StudentEnrollments")

  // NEW: Tutor sessions (sessions where this user is the tutor)
  tutorSessions             Session[]                  @relation("TutorSessions")

  // Parent-Student relationships
  parentId      String?
  parent        User?    @relation("ParentStudents", fields: [parentId], references: [id], onDelete: SetNull)
  children      User[]   @relation("ParentStudents")
  
  // Phase 1 relationships
  requestedApprovals ApprovalRequest[] @relation("RequestedApprovals")
  approvedApprovals  ApprovalRequest[] @relation("ApprovedApprovals")
  taughtClasses      ClassCohort[]     @relation("TaughtClasses")
  classMemberships   ClassMembership[] @relation("ClassMemberships")
  attendanceRecords  AttendanceRecord[] @relation("AttendanceRecords")
  markedAttendance   AttendanceRecord[] @relation("MarkedAttendance")
  catchUpPackages    CatchUpPackage[]   @relation("CatchUpPackages")
  createdTickets     Ticket[]           @relation("CreatedTickets")
  assignedTickets    Ticket[]           @relation("AssignedTickets")
  ticketComments     TicketComment[]    @relation("TicketComments")
  ticketAttachments  TicketAttachment[] @relation("TicketAttachments")
  studentAccount     StudentAccount?    @relation("StudentAccount")
  recordedPayments   Payment[]          @relation("RecordedPayments")
  requestedRefunds   Refund[]           @relation("RequestedRefunds")
  approvedRefunds    Refund[]           @relation("ApprovedRefunds")

  // Phase 1: Individualized Tutoring Platform
  studentAssessments      SubjectAssessment[]   @relation("StudentAssessments")
  assessorAssessments     SubjectAssessment[]   @relation("AssessorAssessments")
  studentProfileLogs      AcademicProfileLog[]  @relation("StudentProfileLogs")
  updatedByLogs           AcademicProfileLog[]  @relation("UpdatedByLogs")
  studentAttempts         ExerciseAttempt[]     @relation("StudentAttempts")
  studentHomework         HomeworkAssignment[]  @relation("StudentHomework")
  assignedHomework        HomeworkAssignment[]  @relation("AssignedHomework")
  assessorReviews         AssessmentReview[]    @relation("AssessorReviews")
  studentPhysicalWork     PhysicalWorkUpload[]  @relation("StudentPhysicalWork")
  uploadedPhysicalWork    PhysicalWorkUpload[]  @relation("UploadedPhysicalWork")
  studentHelpRequests     HelpRequest[]         @relation("StudentHelpRequests")
  resolvedHelpRequests    HelpRequest[]         @relation("ResolvedHelpRequests")
  studentNotes            TutorNote[]           @relation("StudentNotes")
  tutorNotes              TutorNote[]           @relation("TutorNotes")
  assignedByTutor         ContentAssignment[]   @relation("AssignedByTutor")
  assignedToStudent       ContentAssignment[]   @relation("AssignedToStudent")
  studentGoals            StudentGoal[]         @relation("StudentGoals")
  studentTraits           StudentStrengthWeakness[] @relation("StudentTraits")
  identifiedTraits        StudentStrengthWeakness[] @relation("IdentifiedTraits")
  sentMessages            ChatMessage[]         @relation("SentMessages")
  receivedMessages        ChatMessage[]         @relation("ReceivedMessages")
  notifications           Notification[]        @relation("UserNotifications")
  studentRedemptions      AwardRedemption[]     @relation("StudentRedemptions")
  tutorTemplates          SessionTemplate[]     @relation("TutorTemplates")
  studentWhiteboards      WhiteboardState[]     @relation("StudentWhiteboards")
  sessionPresenceLogs     SessionPresenceLog[]
  activityLogs            ActivityLog[]
  
  // Phase 1: In-built video conferencing
  videoParticipations     VideoParticipant[]    @relation("UserVideoParticipants")

  @@index([centerId])
  @@index([email])
  @@index([parentId])
}

// Course model
model Course {
  id          String   @id @default(cuid())
  title       String
  slug        String
  description String?
  thumbnail   String?
  status      CourseStatus @default(DRAFT)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Multi-tenant relationship
  centerId    String
  center      Center   @relation(fields: [centerId], references: [id], onDelete: Cascade)
  
  // Teacher relationship
  teacherId   String
  teacher     User     @relation("TeacherCourses", fields: [teacherId], references: [id])
  
  // Course hierarchy
  modules     Module[]
  enrollments Enrollment[]

  // NEW: Session enrollments (students working on this course in sessions)
  sessionEnrollments StudentSessionEnrollment[] @relation("SessionEnrollments")

  // Phase 1: Individualized Tutoring Platform
  courseAssessments      SubjectAssessment[]      @relation("CourseAssessments")
  courseProfileLogs      AcademicProfileLog[]     @relation("CourseProfileLogs")
  courseUnits            ContentUnit[]            @relation("CourseUnits")
  courseHomework         HomeworkAssignment[]     @relation("CourseHomework")
  courseRubrics          AssessmentRubric[]       @relation("CourseRubrics")
  courseNotes            TutorNote[]              @relation("CourseNotes")
  courseAssignments      ContentAssignment[]      @relation("CourseAssignments")
  courseTraits           StudentStrengthWeakness[] @relation("CourseTraits")

  @@unique([centerId, slug])
  @@index([centerId])
  @@index([teacherId])
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Module model - course hierarchy
model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  lessons     Lesson[]
  
  @@index([courseId])
}

// Lesson model - module hierarchy
model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  // Phase 1: Link to ContentUnit (optional, for new content hierarchy)
  unitId      String?
  unit        ContentUnit? @relation("UnitLessons", fields: [unitId], references: [id], onDelete: SetNull)

  contents    Content[]
  progress    Progress[]

  // NEW: Session enrollments (students working on this lesson in sessions)
  sessionEnrollments StudentSessionEnrollment[] @relation("SessionEnrollments")

  // Phase 1: Exercises
  exercises   Exercise[]   @relation("LessonExercises")

  @@index([moduleId])
  @@index([unitId])
}

// Content model - supports multiple content types
enum ContentType {
  DOCUMENT  // PDF, Word, etc.
  VIDEO     // MP4, WebM, etc.
  SCORM     // SCORM packages
  XAPI      // xAPI/TinCan content
  EMBED     // Embedded content (YouTube, etc.)
  QUIZ      // Quiz/Assessment
}

model Content {
  id          String      @id @default(cuid())
  title       String
  type        ContentType
  url         String      // File URL or embed URL
  duration    Int?        // Duration in minutes for videos
  fileSize    Int?        // File size in bytes
  metadata    Json?       // Additional metadata for SCORM/xAPI
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  lessonId    String
  lesson      Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@index([lessonId])
}

// Enrollment model - student course enrollment
model Enrollment {
  id            String   @id @default(cuid())
  enrolledAt    DateTime @default(now())
  completedAt   DateTime?
  progress      Float    @default(0) // Percentage 0-100
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courseId      String
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Tutor allocation
  tutorId       String?  // Assigned tutor for this enrollment
  
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([tutorId])
  @@index([userId, enrolledAt]) // Compound index for enrollment history queries
  @@index([userId, completedAt]) // ⚡ Bolt: Optimize active enrollment lookups
}

// Progress tracking model
model Progress {
  id            String   @id @default(cuid())
  completed     Boolean  @default(false)
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  timeSpent     Int      @default(0) // Time spent in minutes
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lessonId      String
  lesson        Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

// Academic Profile - tracks student academic age and performance
model AcademicProfile {
  id                  String   @id @default(cuid())
  chronologicalAge    Float?   // Age in years
  readingAge          Float?   // Reading age in years
  numeracyAge         Float?   // Numeracy/Math age in years
  comprehensionIndex  Float?   // Comprehension level (0-100)
  writingProficiency  Float?   // Writing proficiency level (0-100)
  
  // NEW: Subject-level tracking for multi-level learning
  // Format: { "English": { "targetLevel": "Grade 4", "currentLevel": "Grade 3" }, "Math": { ... } }
  subjectLevels       Json?    // Subject-specific learning levels
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// Financial Transaction - tracks payments and billing
enum TransactionType {
  STUDENT_FEE      // Fee charged to student
  STUDENT_PAYMENT  // Payment received from student
  TUTOR_PAYMENT    // Payment to tutor
  OPERATIONAL_COST // Other operational costs
  REFUND           // Refund to student
}

model FinancialTransaction {
  id          String          @id @default(cuid())
  amount      Float
  type        TransactionType
  description String?
  status      String          @default("pending") // pending, completed, failed
  metadata    Json?           // Additional transaction details
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  centerId    String
  center      Center          @relation(fields: [centerId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([centerId])
  @@index([type])
  @@index([createdAt])
}

// Session - Live classroom sessions (Teams/Zoom integration)
// MAJOR PIVOT: Sessions now support multiple students working on different courses/levels
// at the same time with the same tutor
enum SessionProvider {
  TEAMS
  ZOOM
  CHIME
  OTHER
}

enum SessionStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

model Session {
  id              String         @id @default(cuid())
  title           String
  description     String?
  provider        SessionProvider
  providerMeetingId String?      // Meeting ID from provider (deprecated for video)
  joinUrl         String?        // Join URL for the session (deprecated for video)
  startTime       DateTime
  endTime         DateTime?
  timezone        String         @default("Australia/Sydney")
  duration        Int?           // Duration in minutes (calculated from endTime-startTime or set manually)
  status          SessionStatus  @default(SCHEDULED)
  recordingUrl    String?        // Recording URL after session (deprecated - use VideoRecording)
  transcriptUrl   String?        // Transcript URL (deprecated - use VideoRecording)
  metadata        Json?          // Provider-specific metadata
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Session mode and location
  sessionMode     SessionMode    @default(ONLINE)
  meetingLink     String?        // Manual meeting link for ONLINE mode
  physicalLocation String?       // Location description for PHYSICAL mode
  
  // NEW: In-built video conferencing fields (Phase 1)
  videoProvider     VideoProvider  @default(DAILY)
  videoRoomId       String?        @unique  // Daily.co room ID
  videoRoomUrl      String?                 // Daily.co room URL
  recordingStartedAt DateTime?              // When recording started
  
  // REMOVED: lessonId - no longer tied to a single lesson
  // Sessions now support multiple students on different content

  tutorId         String         // Required - every session has a tutor
  tutor           User           @relation("TutorSessions", fields: [tutorId], references: [id])
  centreId        String
  centre          Center         @relation(fields: [centreId], references: [id], onDelete: Cascade)

  // Phase 1: Link to ClassCohort (optional, for group management)
  classId         String?
  class           ClassCohort?   @relation("ClassSessions", fields: [classId], references: [id])
  
  // NEW: Student enrollments with individual course/lesson assignments
  studentEnrollments StudentSessionEnrollment[]
  presenceLogs    SessionPresenceLog[]
  
  attendance      SessionAttendance[]
  attendanceRecords AttendanceRecord[] @relation("AttendanceRecords")
  catchUpPackages CatchUpPackage[]   @relation("CatchUpPackages")

  // Phase 1: Real-time session interaction
  helpRequests    HelpRequest[]
  chatMessages    ChatMessage[]
  whiteboards     WhiteboardState[]
  
  // Phase 1: In-built video conferencing
  videoParticipants VideoParticipant[] @relation("VideoParticipants")
  videoRecordings   VideoRecording[]   @relation("VideoRecordings")

  @@index([tutorId])
  @@index([startTime])
  @@index([status])
  @@index([classId])
  @@index([videoRoomId])
  @@index([tutorId, startTime]) // Compound index for tutor's schedule queries
  @@index([centreId, startTime]) // Compound index for center-wide scheduling
}

// NEW: Student Session Enrollment
// Tracks individual student participation in a session with their specific course/lesson
model StudentSessionEnrollment {
  id              String   @id @default(cuid())
  
  sessionId       String
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         User     @relation("StudentEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  
  // Each student can work on different content
  courseId        String?  // Optional: track which course
  course          Course?  @relation("SessionEnrollments", fields: [courseId], references: [id], onDelete: SetNull)
  
  lessonId        String?  // Optional: track which lesson
  lesson          Lesson?  @relation("SessionEnrollments", fields: [lessonId], references: [id], onDelete: SetNull)
  
  // Custom content for this student in this session
  exerciseContent Json?    // Exercises/activities assigned to this student
  assessmentData  Json?    // Assessment results/answers for this student
  
  // Student's progress in this session
  completed       Boolean  @default(false)
  notes           String?  // Tutor notes specific to this student's session
  centreId        String
  centre          Center   @relation(fields: [centreId], references: [id], onDelete: Cascade)

  // time tracking granularity
  joinedAt     DateTime?
  leftAt       DateTime?
  activeMs     Int @default(0)   // accumulated active time
  lastActiveAt DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Phase 1: Real-time session tracking
  exerciseAttempts    ExerciseAttempt[]
  homeworkAssignments HomeworkAssignment[]
  physicalUploads     PhysicalWorkUpload[]
  helpRequests        HelpRequest[]
  activities          StudentSessionActivity[]
  tutorNotes          TutorNote[]
  contentAssignments  ContentAssignment[]
  presenceLogs        SessionPresenceLog[]
  activityLogs        ActivityLog[]

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([courseId])
  @@index([lessonId])
}

// Session Attendance - track student attendance in live sessions
model SessionAttendance {
  id          String   @id @default(cuid())
  joinedAt    DateTime?
  leftAt      DateTime?
  attended    Boolean  @default(false)
  
  sessionId   String
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

// Gamification Profile - XP, levels, and achievements
model GamificationProfile {
  id              String   @id @default(cuid())
  xp              Int      @default(0)
  level           Int      @default(1)
  streak          Int      @default(0) // Consecutive days of activity
  lastActivityAt  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // NEW: Additional tracking (nullable - won't break existing)
  totalXP         Int?     @default(0)  // Lifetime XP
  nextLevelXP     Int?     @default(100)

  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  badges          Badge[]
  achievements    Achievement[]

  @@index([userId])
  @@index([level])
  @@index([xp])
}

// Badge - Achievement badges
enum BadgeType {
  COMPLETION      // Course/lesson completion
  STREAK          // Activity streak
  MASTERY         // Subject mastery
  PARTICIPATION   // Active participation
  SPECIAL         // Special achievements
}

model Badge {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        BadgeType
  iconUrl     String?
  earnedAt    DateTime @default(now())
  
  profileId   String
  profile     GamificationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId])
  @@index([type])
}

// Achievement - Milestones and accomplishments
model Achievement {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String   // e.g., "reading", "math", "attendance"
  value       Float?   // Achievement value (e.g., 100% completion)
  earnedAt    DateTime @default(now())

  profileId   String
  profile     GamificationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([category])
}

// ============================================================================
// ENHANCED GAMIFICATION MODELS - XP Transactions, Badges, Streaks
// ============================================================================

// XP Transaction Log
model XPTransaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Int      // XP earned
  source      XPSource
  sourceId    String?  // ID of the activity
  description String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([source])
}

enum XPSource {
  LESSON_COMPLETION
  HOMEWORK_SUBMISSION
  HOMEWORK_ONTIME
  SESSION_ATTENDANCE
  QUIZ_COMPLETION
  QUIZ_PERFECT
  READING_ACTIVITY
  HELPING_PEER
  STREAK_MILESTONE
  AWARD_REDEMPTION
  AWARD_REFUND
  GOAL_COMPLETE
  EXERCISE_COMPLETE
}

// Badge Definitions (reusable templates)
model BadgeDefinition {
  id          String     @id @default(cuid())
  name        String     @unique
  description String
  category    BadgeCategory
  tier        BadgeTier
  iconUrl     String?
  xpValue     Int        @default(0)
  criteria    Json       // Unlock conditions
  isActive    Boolean    @default(true)

  awards      BadgeAward[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([category])
  @@index([tier])
}

enum BadgeCategory {
  COMPLETION
  STREAK
  MASTERY
  SOCIAL
  SPECIAL
}

enum BadgeTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

// Badge Awards (to users)
model BadgeAward {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId         String
  badge           BadgeDefinition  @relation(fields: [badgeId], references: [id])
  awardedAt       DateTime         @default(now())

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([awardedAt])
}

// Streak Tracking
model Streak {
  id              String     @id @default(cuid())
  userId          String     @unique
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            StreakType
  currentStreak   Int        @default(0)
  longestStreak   Int        @default(0)
  lastActivityAt  DateTime   @default(now())
  freezesAvailable Int       @default(1)

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([userId])
  @@index([type])
}

enum StreakType {
  ATTENDANCE
  HOMEWORK
  READING
  LOGIN
}

// Leaderboard Opt-In
model LeaderboardOptIn {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled   Boolean  @default(false)
  scope     String   @default("class") // "class", "centre", "global"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// PHASE 1 MODELS - Governance, Academic, Operations, Finance
// ============================================================================

// Governance Domain - Audit Logging
enum AuditAction {
  CREATE
  UPDATE
  DELETE
  APPROVE
  REJECT
  ESCALATE
}

model AuditEvent {
  id            String      @id @default(cuid())
  userId        String      // Actor who performed the action
  userName      String      // Denormalized for reporting
  userRole      Role        // Role at time of action
  
  action        AuditAction
  resourceType  String      // e.g., "Refund", "Invoice", "Ticket"
  resourceId    String      // ID of the affected resource
  
  beforeState   Json?       // State before the action (UPDATE/DELETE)
  afterState    Json?       // State after the action (CREATE/UPDATE)
  
  centreId      String      // Multi-tenancy
  centre        Center      @relation("AuditEvents", fields: [centreId], references: [id])
  
  ipAddress     String?     // Client IP address
  metadata      Json?       // Additional context
  
  createdAt     DateTime    @default(now())
  
  @@index([centreId])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@index([createdAt])
}

// Governance Domain - Approval Workflow
enum ApprovalType {
  REFUND
  TUTOR_OVERRIDE
  PAYROLL_EXCEPTION
  FEE_WAIVER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

model ApprovalRequest {
  id              String          @id @default(cuid())
  type            ApprovalType
  
  requestedById   String
  requestedBy     User            @relation("RequestedApprovals", fields: [requestedById], references: [id])
  requestedByName String          // Denormalized
  
  status          ApprovalStatus  @default(PENDING)
  
  approvedById    String?
  approvedBy      User?           @relation("ApprovedApprovals", fields: [approvedById], references: [id])
  approvedByName  String?         // Denormalized
  approvedAt      DateTime?
  
  resourceType    String          // e.g., "Refund"
  resourceId      String          // e.g., refund_123
  
  metadata        Json            // Type-specific data (amount, reason, etc.)
  comment         String?         // Approver's comment
  
  centreId        String
  centre          Center          @relation("ApprovalRequests", fields: [centreId], references: [id])
  
  expiresAt       DateTime        // Auto-reject if not actioned
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  refunds         Refund[]
  
  @@index([centreId, status])
  @@index([requestedById])
  @@index([approvedById])
  @@index([type])
  @@index([expiresAt])
}

// Academic Domain - Classes/Cohorts
enum ClassStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum Subject {
  ENGLISH
  MATHEMATICS
  STEM
  SCIENCE
  OTHER
}

model ClassCohort {
  id                String            @id @default(cuid())
  name              String            // "Math Grade 5 - Spring 2026"
  subject           String            // "Mathematics"
  subjectEnum       Subject?          // New structured subject
  description       String?

  startDate         DateTime
  endDate           DateTime?  // Optional - class might be ongoing

  gradeMin          Int?
  gradeMax          Int?
  isActive          Boolean           @default(true)

  maxCapacity       Int               @default(20)
  currentEnrollment Int               @default(0)
  
  status            ClassStatus       @default(ACTIVE)
  
  teacherId         String
  teacher           User              @relation("TaughtClasses", fields: [teacherId], references: [id])
  
  centreId          String
  centre            Center            @relation("Classes", fields: [centreId], references: [id])
  
  members           ClassMembership[]
  sessions          Session[]         @relation("ClassSessions")
  scheduleRules     ClassScheduleRule[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([centreId])
  @@index([teacherId])
  @@index([status])
  @@index([startDate, endDate])
}

// Academic Domain - Class Membership
enum MembershipStatus {
  ACTIVE
  DROPPED
  COMPLETED
}

model ClassMembership {
  id          String           @id @default(cuid())
  
  classId     String
  class       ClassCohort      @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     User             @relation("ClassMemberships", fields: [studentId], references: [id], onDelete: Cascade)
  
  status      MembershipStatus @default(ACTIVE)
  joinedAt    DateTime         @default(now())
  leftAt      DateTime?
  
  centreId    String           // Denormalized for efficient queries
  
  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@index([centreId, status])
}

// Academic Domain - Attendance Records
enum AttendanceStatus {
  PENDING
  PRESENT
  ABSENT
  LATE
  EXCUSED
  CANCELLED
}

model AttendanceRecord {
  id          String            @id @default(cuid())
  
  sessionId   String
  session     Session           @relation("AttendanceRecords", fields: [sessionId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     User              @relation("AttendanceRecords", fields: [studentId], references: [id], onDelete: Cascade)
  
  status      AttendanceStatus  @default(PENDING)
  
  markedAt    DateTime?
  markedById  String?
  markedBy    User?             @relation("MarkedAttendance", fields: [markedById], references: [id])
  
  notes       String?
  
  centreId    String            // Denormalized
  
  catchUpPackage CatchUpPackage?
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([centreId, sessionId])
  @@index([status])
}

// Academic Domain - Catch-Up Packages
enum CatchUpStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

model CatchUpPackage {
  id          String        @id @default(cuid())
  
  studentId   String
  student     User          @relation("CatchUpPackages", fields: [studentId], references: [id], onDelete: Cascade)
  
  sessionId   String
  session     Session       @relation("CatchUpPackages", fields: [sessionId], references: [id])
  
  attendanceId String       @unique
  attendance  AttendanceRecord @relation(fields: [attendanceId], references: [id])
  
  status      CatchUpStatus @default(PENDING)
  
  dueDate     DateTime      // Auto-calculated: missedDate + 7 days
  slaDueAt    DateTime?     // Precomputed for escalation jobs
  completedAt DateTime?
  
  resources   Json          // Array of { type, url, title, duration }
  notes       String?
  
  centreId    String
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([studentId, status])
  @@index([centreId])
  @@index([dueDate])
}

// Operations Domain - Tickets
enum TicketType {
  IT
  INVENTORY
  COMPLAINT
  MAINTENANCE
  GENERAL
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  ESCALATED
}

model Ticket {
  id            String          @id @default(cuid())
  ticketNumber  String          @unique // TICK-2026-0001
  
  type          TicketType
  priority      TicketPriority
  status        TicketStatus    @default(OPEN)
  
  subject       String          // 5-200 chars
  description   String          @db.Text // 10-2000 chars
  
  createdById   String
  createdBy     User            @relation("CreatedTickets", fields: [createdById], references: [id])
  
  assignedToId  String?
  assignedTo    User?           @relation("AssignedTickets", fields: [assignedToId], references: [id])
  
  resolution    String?         @db.Text // Filled when RESOLVED/CLOSED
  
  slaDueAt      DateTime        // Auto-calculated from SLAConfig
  isOverdue     Boolean         @default(false)
  
  centreId      String
  centre        Center          @relation("Tickets", fields: [centreId], references: [id])
  
  comments      TicketComment[]
  attachments   TicketAttachment[]
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([centreId, status])
  @@index([createdById])
  @@index([assignedToId])
  @@index([ticketNumber])
  @@index([slaDueAt])
  @@index([centreId, status, slaDueAt])
}

model TicketComment {
  id          String    @id @default(cuid())
  
  ticketId    String
  ticket      Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User      @relation("TicketComments", fields: [userId], references: [id])
  userName    String    // Denormalized
  
  text        String    @db.Text
  isInternal  Boolean   @default(false) // Internal notes vs public comments
  isSystem    Boolean   @default(false) // System-generated
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([ticketId])
  @@index([userId])
}

model TicketAttachment {
  id          String    @id @default(cuid())
  
  ticketId    String
  ticket      Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  filename    String
  url         String    // Cloud storage URL
  mimeType    String
  size        Int       // Bytes
  
  uploadedById String
  uploadedBy  User      @relation("TicketAttachments", fields: [uploadedById], references: [id])
  
  createdAt   DateTime  @default(now())
  
  @@index([ticketId])
}

model SLAConfig {
  id          String         @id @default(cuid())
  
  ticketType  TicketType
  priority    TicketPriority
  
  responseTimeHours   Int    // Time to first response
  resolutionTimeHours Int    // Time to resolution
  
  centreId    String
  centre      Center         @relation("SLAConfigs", fields: [centreId], references: [id])
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@unique([centreId, ticketType, priority])
  @@index([centreId])
}

// Finance Domain - Fee Plans
enum BillingFrequency {
  ONE_TIME
  WEEKLY
  MONTHLY
  TERM
  ANNUAL
}

enum FeePlanStatus {
  ACTIVE
  ARCHIVED
}

model FeePlan {
  id          String          @id @default(cuid())
  name        String
  description String?
  
  amount      Decimal         @db.Decimal(10, 2)
  currency    String          @default("USD")
  
  frequency   BillingFrequency
  
  // Optional filters
  applicableCourses Json?     // Array of course IDs
  applicableClasses Json?     // Array of class IDs
  
  status      FeePlanStatus   @default(ACTIVE)
  
  centreId    String
  centre      Center          @relation("FeePlans", fields: [centreId], references: [id])
  
  invoices    Invoice[]
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([centreId, status])
}

// Finance Domain - Student Accounts
model StudentAccount {
  id          String    @id @default(cuid())
  
  studentId   String    @unique
  student     User      @relation("StudentAccount", fields: [studentId], references: [id], onDelete: Cascade)
  
  totalBilled    Decimal @db.Decimal(10, 2) @default(0)
  totalPaid      Decimal @db.Decimal(10, 2) @default(0)
  totalRefunded  Decimal @db.Decimal(10, 2) @default(0)
  balance        Decimal @db.Decimal(10, 2) @default(0) // Calculated
  
  centreId    String
  centre      Center    @relation("StudentAccounts", fields: [centreId], references: [id])
  
  invoices    Invoice[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([centreId])
  @@index([studentId])
}

// Finance Domain - Invoices
enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id            String         @id @default(cuid())
  invoiceNumber String         @unique // INV-2026-0001
  
  studentAccountId String
  studentAccount StudentAccount @relation(fields: [studentAccountId], references: [id])
  
  studentId     String         // Denormalized for queries
  
  feePlanId     String?
  feePlan       FeePlan?       @relation(fields: [feePlanId], references: [id])
  
  issueDate     DateTime       @default(now())
  dueDate       DateTime
  sentAt        DateTime?
  
  status        InvoiceStatus  @default(DRAFT)
  
  subtotal      Decimal        @db.Decimal(10, 2)
  tax           Decimal        @db.Decimal(10, 2) @default(0)
  total         Decimal        @db.Decimal(10, 2)
  
  paidAmount    Decimal        @db.Decimal(10, 2) @default(0)
  balance       Decimal        @db.Decimal(10, 2) // Calculated: total - paidAmount
  
  notes         String?        @db.Text
  
  centreId      String
  centre        Center         @relation("Invoices", fields: [centreId], references: [id])
  
  lineItems     InvoiceLine[]
  payments      Payment[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@index([centreId, status])
  @@index([studentId])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@index([centreId, status, dueDate])
}

model InvoiceLine {
  id          String    @id @default(cuid())
  
  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Int       @default(1)
  unitPrice   Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(10, 2) // quantity * unitPrice
  
  order       Int       @default(0) // Display order
  
  createdAt   DateTime  @default(now())
  
  @@index([invoiceId])
}

// Finance Domain - Payments
enum PaymentMethod {
  CASH
  CHECK
  BANK_TRANSFER
  CARD
  OTHER
}

model Payment {
  id          String        @id @default(cuid())
  
  invoiceId   String
  invoice     Invoice       @relation(fields: [invoiceId], references: [id])
  
  amount      Decimal       @db.Decimal(10, 2)
  
  method      PaymentMethod
  paymentDate DateTime
  reference   String?       // Check number, transaction ID, etc.
  
  notes       String?       @db.Text
  
  recordedById String
  recordedBy  User          @relation("RecordedPayments", fields: [recordedById], references: [id])
  
  centreId    String
  
  refunds     Refund[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([invoiceId])
  @@index([centreId])
  @@index([paymentDate])
}

// Finance Domain - Refunds
enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

model Refund {
  id          String        @id @default(cuid())
  refundNumber String       @unique // REF-2026-0001
  
  paymentId   String
  payment     Payment       @relation(fields: [paymentId], references: [id])
  
  amount      Decimal       @db.Decimal(10, 2)
  reason      String        @db.Text
  
  status      RefundStatus  @default(PENDING)
  
  refundMethod String?      // ORIGINAL_METHOD, BANK_TRANSFER, etc.
  
  processedDate DateTime?
  processedReference String?
  
  requestedById String
  requestedBy User          @relation("RequestedRefunds", fields: [requestedById], references: [id])
  
  approvedById String?
  approvedBy  User?         @relation("ApprovedRefunds", fields: [approvedById], references: [id])
  approvedAt  DateTime?
  
  approvalRequestId String?  @unique
  approvalRequest ApprovalRequest? @relation(fields: [approvalRequestId], references: [id])
  
  centreId    String
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([centreId, status])
  @@index([paymentId])
  @@index([refundNumber])
}

// =============================================================================
// PHASE 1: INDIVIDUALIZED TUTORING PLATFORM MODELS
// Architecture: Multi-student, multi-course, multi-level sessions
// =============================================================================

// -----------------------------------------------------------------------------
// Academic Assessment System
// -----------------------------------------------------------------------------

// Per-subject assessed levels (Grade 7 student learning at Grade 4 English)
model SubjectAssessment {
  id                  String    @id @default(cuid())
  studentId           String
  courseId            String
  assessedGradeLevel  Int       // The grade level they're working at (e.g., 4)
  readingAge          Float?    // In years, e.g., 8.5
  numeracyAge         Float?
  comprehensionLevel  Float?
  writingLevel        Float?
  lastAssessedAt      DateTime  @default(now())
  assessedById        String    // Who made this assessment
  notes               String?   @db.Text
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  student             User      @relation("StudentAssessments", fields: [studentId], references: [id], onDelete: Cascade)
  course              Course    @relation("CourseAssessments", fields: [courseId], references: [id], onDelete: Cascade)
  assessedBy          User      @relation("AssessorAssessments", fields: [assessedById], references: [id])
  profileLogs         AcademicProfileLog[]

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@index([assessedGradeLevel])
}

enum ProfileUpdateType {
  ASSESSMENT_RESULT
  TUTOR_OVERRIDE
  DIAGNOSTIC_TEST
  LEVEL_ADVANCEMENT
  LEVEL_REGRESSION
}

// Track all changes to academic profiles over time
model AcademicProfileLog {
  id                  String            @id @default(cuid())
  studentId           String
  courseId            String
  subjectAssessmentId String
  previousLevel       Int
  newLevel            Int
  updateType          ProfileUpdateType
  reason              String?           @db.Text
  updatedById         String
  assessmentReviewId  String?
  createdAt           DateTime          @default(now())

  student             User              @relation("StudentProfileLogs", fields: [studentId], references: [id], onDelete: Cascade)
  course              Course            @relation("CourseProfileLogs", fields: [courseId], references: [id], onDelete: Cascade)
  subjectAssessment   SubjectAssessment @relation(fields: [subjectAssessmentId], references: [id], onDelete: Cascade)
  updatedBy           User              @relation("UpdatedByLogs", fields: [updatedById], references: [id])
  assessmentReview    AssessmentReview? @relation(fields: [assessmentReviewId], references: [id], onDelete: SetNull)

  @@index([studentId, courseId])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// Content Hierarchy: Course → GradeLevel → ContentUnit → Lesson → Exercise
// -----------------------------------------------------------------------------

// Grade levels (Class 1, Class 2, etc.)
model GradeLevel {
  id          String   @id @default(cuid())
  level       Int      @unique  // 1, 2, 3... representing Class 1, Class 2...
  label       String             // "Class 1", "Class 2", "Year 1", etc.

  units       ContentUnit[]
  assessmentRubrics AssessmentRubric[]

  @@index([level])
}

// Content units within a grade level
model ContentUnit {
  id            String    @id @default(cuid())
  courseId      String
  gradeLevelId  String
  sequenceOrder Int
  title         String
  description   String?   @db.Text
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  course        Course     @relation("CourseUnits", fields: [courseId], references: [id], onDelete: Cascade)
  gradeLevel    GradeLevel @relation(fields: [gradeLevelId], references: [id], onDelete: Cascade)
  lessons       Lesson[]   @relation("UnitLessons")

  @@unique([courseId, gradeLevelId, sequenceOrder])
  @@index([courseId, gradeLevelId])
}

// -----------------------------------------------------------------------------
// Exercise System
// -----------------------------------------------------------------------------

enum ExerciseType {
  MULTIPLE_CHOICE
  FILL_IN_BLANK
  SHORT_ANSWER
  LONG_ANSWER
  NUMERICAL
  MATCHING
  WORKSHEET    // Physical work
}

// Granular exercises within lessons
model Exercise {
  id              String       @id @default(cuid())
  lessonId        String
  unitId          String?      // Denormalized for easier queries
  sequenceOrder   Int
  exerciseType    ExerciseType
  title           String
  instructions    String?      @db.Text
  questions       Json         // [{question, options?, type}]
  expectedAnswers Json?        // [{answer, acceptableVariants?}]
  maxScore        Int
  timeLimit       Int?         // in minutes
  isAutoGradable  Boolean      @default(false)
  difficulty      String?      // EASY, MEDIUM, HARD, CHALLENGE
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  lesson          Lesson       @relation("LessonExercises", fields: [lessonId], references: [id], onDelete: Cascade)
  attempts        ExerciseAttempt[]
  physicalUploads PhysicalWorkUpload[]
  homeworkAssignments HomeworkAssignment[]
  homeworkExercises   HomeworkExercise[] @relation("HomeworkExerciseJunction")
  contentAssignments  ContentAssignment[]
  activities      StudentSessionActivity[] @relation("ActivityExercises")
  helpRequests    HelpRequest[] @relation("HelpRequestExercises")

  @@unique([lessonId, sequenceOrder])
  @@index([lessonId])
  @@index([exerciseType])
  @@index([isActive])
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  AUTO_GRADED
  UNDER_REVIEW
  GRADED
}

// Student attempts at exercises
model ExerciseAttempt {
  id                  String       @id @default(cuid())
  studentId           String
  exerciseId          String
  sessionEnrollmentId String?
  homeworkAssignmentId String?
  answers             Json         // [{questionIndex, answer, isCorrect?}]
  score               Float?
  maxScore            Int
  status              AttemptStatus @default(IN_PROGRESS)
  startedAt           DateTime     @default(now())
  submittedAt         DateTime?
  autoGraded          Boolean      @default(false)
  timeSpent           Int?         // seconds
  questionTimes       Json?        // [{questionIndex, timeSpentSeconds}]
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  student             User                      @relation("StudentAttempts", fields: [studentId], references: [id], onDelete: Cascade)
  exercise            Exercise                  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  sessionEnrollment   StudentSessionEnrollment? @relation(fields: [sessionEnrollmentId], references: [id], onDelete: SetNull)
  homeworkAssignment  HomeworkAssignment?       @relation(fields: [homeworkAssignmentId], references: [id], onDelete: SetNull)
  reviews             AssessmentReview[]

  @@index([studentId, exerciseId])
  @@index([sessionEnrollmentId])
  @@index([homeworkAssignmentId])
  @@index([status])
  @@index([submittedAt])
  @@index([studentId, submittedAt]) // Compound index for student activity history
  @@index([studentId, createdAt]) // Compound index for recent attempts
}

// -----------------------------------------------------------------------------
// Homework System
// -----------------------------------------------------------------------------

enum HomeworkStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  GRADED
  RETURNED
}

model HomeworkAssignment {
  id                  String         @id @default(cuid())
  centreId            String
  studentId           String
  courseId            String
  exerciseId          String         // Primary/main exercise (for backwards compatibility)
  assignedById        String         // Tutor who assigned it
  sessionEnrollmentId String?        // Session during which it was assigned
  dueDate             DateTime
  status              HomeworkStatus @default(NOT_STARTED)
  totalMaxScore       Int            @default(0)  // Sum of all exercises' maxScore
  totalScore          Float?         // Actual score achieved
  startedAt           DateTime?
  submittedAt         DateTime?
  gradedAt            DateTime?
  gradedById          String?        // Who graded this homework
  feedback            String?        @db.Text
  notes               String?        @db.Text
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  student             User           @relation("StudentHomework", fields: [studentId], references: [id], onDelete: Cascade)
  course              Course         @relation("CourseHomework", fields: [courseId], references: [id], onDelete: Cascade)
  exercise            Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  assignedBy          User           @relation("AssignedHomework", fields: [assignedById], references: [id])
  sessionEnrollment   StudentSessionEnrollment? @relation(fields: [sessionEnrollmentId], references: [id], onDelete: SetNull)
  attempts            ExerciseAttempt[]
  exercises           HomeworkExercise[] // Many-to-many: multiple exercises per homework

  @@index([centreId, studentId, status])
  @@index([studentId, dueDate])
  @@index([assignedById])
  @@index([courseId])
}

// Junction table for homework assignments with multiple exercises
model HomeworkExercise {
  id           String             @id @default(cuid())
  homeworkId   String
  exerciseId   String
  order        Int                @default(0) // Order in which exercises should be completed
  isCompleted  Boolean            @default(false)
  score        Float?
  createdAt    DateTime           @default(now())

  homework     HomeworkAssignment @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  exercise     Exercise           @relation("HomeworkExerciseJunction", fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, exerciseId])
  @@index([homeworkId])
  @@index([exerciseId])
}

// -----------------------------------------------------------------------------
// Assessment & Review System
// -----------------------------------------------------------------------------

enum AssessmentStatus {
  PENDING
  IN_REVIEW
  COMPLETED
  RETURNED
}

model AssessmentReview {
  id                   String           @id @default(cuid())
  assessorId           String
  exerciseAttemptId    String?
  physicalWorkUploadId String?
  rubricId             String?
  criteriaScores       Json?            // [{criterionName, score, maxScore, comment}]
  overallScore         Float
  maxScore             Float
  feedback             String?          @db.Text
  status               AssessmentStatus @default(PENDING)
  reviewedAt           DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  assessor             User                @relation("AssessorReviews", fields: [assessorId], references: [id])
  exerciseAttempt      ExerciseAttempt?    @relation(fields: [exerciseAttemptId], references: [id], onDelete: SetNull)
  physicalWorkUpload   PhysicalWorkUpload? @relation(fields: [physicalWorkUploadId], references: [id], onDelete: SetNull)
  rubric               AssessmentRubric?   @relation(fields: [rubricId], references: [id], onDelete: SetNull)
  profileLogs          AcademicProfileLog[]

  @@index([assessorId])
  @@index([exerciseAttemptId])
  @@index([physicalWorkUploadId])
  @@index([status])
}

model AssessmentRubric {
  id            String       @id @default(cuid())
  courseId      String
  gradeLevelId  String
  exerciseType  ExerciseType
  name          String
  description   String?      @db.Text
  criteria      Json         // [{name, description, maxPoints, levels:[]}]
  maxScore      Int
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  course        Course       @relation("CourseRubrics", fields: [courseId], references: [id], onDelete: Cascade)
  gradeLevel    GradeLevel   @relation(fields: [gradeLevelId], references: [id], onDelete: Cascade)
  reviews       AssessmentReview[]

  @@unique([courseId, gradeLevelId, exerciseType, name])
  @@index([courseId, gradeLevelId])
}

// -----------------------------------------------------------------------------
// Physical Work & QR System
// -----------------------------------------------------------------------------

model PhysicalWorkUpload {
  id                  String    @id @default(cuid())
  studentId           String
  exerciseId          String?
  sessionEnrollmentId String?
  imageUrls           String[]  // Array of image URLs in MinIO/S3
  qrCodeIdentifier    String?   @unique  // Links to physical QR code (AE-{studentId}-{exerciseId}-{sessionId})
  annotations         Json?     // Fabric.js canvas JSON for tutor markings
  uploadedById        String
  notes               String?   @db.Text
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  student             User                      @relation("StudentPhysicalWork", fields: [studentId], references: [id], onDelete: Cascade)
  exercise            Exercise?                 @relation(fields: [exerciseId], references: [id], onDelete: SetNull)
  sessionEnrollment   StudentSessionEnrollment? @relation(fields: [sessionEnrollmentId], references: [id], onDelete: SetNull)
  uploadedBy          User                      @relation("UploadedPhysicalWork", fields: [uploadedById], references: [id])
  reviews             AssessmentReview[]

  @@index([studentId])
  @@index([qrCodeIdentifier])
  @@index([sessionEnrollmentId])
  @@index([exerciseId])
}

// -----------------------------------------------------------------------------
// Real-Time Session Interaction
// -----------------------------------------------------------------------------

enum ActivityStatus {
  NOT_STARTED
  WORKING
  WAITING_HELP
  COMPLETED
  IDLE
}

// Track what each student is doing in real-time during a session
model StudentSessionActivity {
  id            String         @id @default(cuid())
  enrollmentId  String
  exerciseId    String?
  status        ActivityStatus @default(NOT_STARTED)
  startedAt     DateTime?
  completedAt   DateTime?
  progressPct   Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  enrollment    StudentSessionEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  exercise      Exercise?                @relation("ActivityExercises", fields: [exerciseId], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([status])
  @@index([exerciseId])
}

enum HelpRequestStatus {
  PENDING
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

enum HelpRequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model HelpRequest {
  id              String            @id @default(cuid())
  studentId       String
  sessionId       String
  enrollmentId    String?
  exerciseId      String?           // Optional - for context about which exercise student needs help with
  message         String?           @db.Text
  priority        HelpRequestPriority @default(MEDIUM)
  status          HelpRequestStatus @default(PENDING)
  createdAt       DateTime          @default(now())
  acknowledgedAt  DateTime?
  resolvedAt      DateTime?
  resolvedById    String?
  responseText    String?           @db.Text
  slaDueAt        DateTime?         // SLA tracking
  centreId        String
  centre          Center            @relation("CentreHelpRequests", fields: [centreId], references: [id], onDelete: Cascade)

  student         User              @relation("StudentHelpRequests", fields: [studentId], references: [id], onDelete: Cascade)
  session         Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  enrollment      StudentSessionEnrollment? @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)
  exercise        Exercise?         @relation("HelpRequestExercises", fields: [exerciseId], references: [id], onDelete: SetNull)
  resolvedBy      User?             @relation("ResolvedHelpRequests", fields: [resolvedById], references: [id])

  @@index([sessionId, status])
  @@index([studentId])
  @@index([createdAt])
  @@index([exerciseId])
  @@index([priority])
  @@index([centreId, status]) // ⚡ Bolt: Optimize multi-tenant list/dashboard queries
}

// -----------------------------------------------------------------------------
// Tutor Notes & Content Assignment
// -----------------------------------------------------------------------------

enum NoteVisibility {
  INTERNAL    // Only tutors/assessors/supervisors can see
  EXTERNAL    // Parents can also see
}

model TutorNote {
  id            String         @id @default(cuid())
  enrollmentId  String?
  studentId     String
  courseId      String?
  tutorId       String
  content       String         @db.Text
  visibility    NoteVisibility @default(INTERNAL)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  enrollment    StudentSessionEnrollment? @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student       User           @relation("StudentNotes", fields: [studentId], references: [id], onDelete: Cascade)
  course        Course?        @relation("CourseNotes", fields: [courseId], references: [id], onDelete: SetNull)
  tutor         User           @relation("TutorNotes", fields: [tutorId], references: [id])

  @@index([enrollmentId])
  @@index([studentId])
  @@index([tutorId])
  @@index([visibility])
}

// Tutor overrides for content auto-sequencing
model ContentAssignment {
  id                    String    @id @default(cuid())
  tutorId               String
  studentId             String
  courseId              String
  sessionEnrollmentId   String?
  exerciseId            String?
  overridesAutoSequence Boolean   @default(true)
  reason                String?   @db.Text
  isActive              Boolean   @default(true)
  assignedAt            DateTime  @default(now())

  tutor                 User                      @relation("AssignedByTutor", fields: [tutorId], references: [id])
  student               User                      @relation("AssignedToStudent", fields: [studentId], references: [id], onDelete: Cascade)
  course                Course                    @relation("CourseAssignments", fields: [courseId], references: [id], onDelete: Cascade)
  sessionEnrollment     StudentSessionEnrollment? @relation(fields: [sessionEnrollmentId], references: [id], onDelete: SetNull)
  exercise              Exercise?                 @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  @@index([studentId, courseId, isActive])
  @@index([sessionEnrollmentId])
  @@index([tutorId])
}

// -----------------------------------------------------------------------------
// Student Goals, Strengths & Weaknesses
// -----------------------------------------------------------------------------

model StudentGoal {
  id          String    @id @default(cuid())
  studentId   String
  goalText    String    @db.Text
  category    String?   // ACADEMIC, PERSONAL, SKILL, etc.
  targetDate  DateTime?
  isAchieved  Boolean   @default(false)
  achievedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  student     User      @relation("StudentGoals", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([isAchieved])
}

model StudentStrengthWeakness {
  id          String    @id @default(cuid())
  studentId   String
  courseId    String?
  type        String    // STRENGTH, WEAKNESS
  description String    @db.Text
  identifiedBy String   // User ID who identified this
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  student     User      @relation("StudentTraits", fields: [studentId], references: [id], onDelete: Cascade)
  course      Course?   @relation("CourseTraits", fields: [courseId], references: [id], onDelete: SetNull)
  identifier  User      @relation("IdentifiedTraits", fields: [identifiedBy], references: [id])

  @@index([studentId])
  @@index([courseId])
  @@index([type])
}

// -----------------------------------------------------------------------------
// Chat System
// -----------------------------------------------------------------------------

enum ChatMessageType {
  STUDENT_TO_TUTOR
  TUTOR_TO_STUDENT
  STUDENT_TO_STUDENT
  SYSTEM
}

model ChatMessage {
  id              String          @id @default(cuid())
  sessionId       String
  senderId        String
  recipientId     String?         // Null for broadcast
  messageType     ChatMessageType
  content         String          @db.Text
  attachmentUrls  String[]
  isRead          Boolean         @default(false)
  createdAt       DateTime        @default(now())

  session         Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sender          User            @relation("SentMessages", fields: [senderId], references: [id])
  recipient       User?           @relation("ReceivedMessages", fields: [recipientId], references: [id])

  @@index([sessionId, createdAt])
  @@index([senderId])
  @@index([recipientId])
}

// -----------------------------------------------------------------------------
// Awards & Redemption System
// -----------------------------------------------------------------------------

enum AwardType {
  GIFT
  STICKER
  COURSE_UNLOCK
  CUSTOM
}

enum RedemptionStatus {
  PENDING
  FULFILLED
  REJECTED
}

model Award {
  id            String     @id @default(cuid())
  centreId      String
  name          String
  description   String?    @db.Text
  awardType     AwardType
  xpCost        Int        // How much XP to redeem
  stockQuantity Int?       // Null = unlimited
  imageUrl      String?
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  centre        Center     @relation("CentreAwards", fields: [centreId], references: [id], onDelete: Cascade)
  redemptions   AwardRedemption[]

  @@index([centreId, isActive])
  @@index([xpCost])
}

model AwardRedemption {
  id          String            @id @default(cuid())
  studentId   String
  awardId     String
  xpSpent     Int
  status      RedemptionStatus  @default(PENDING)
  redeemedAt  DateTime          @default(now())
  fulfilledAt DateTime?
  notes       String?           @db.Text

  student     User      @relation("StudentRedemptions", fields: [studentId], references: [id], onDelete: Cascade)
  award       Award     @relation(fields: [awardId], references: [id])

  @@index([studentId])
  @@index([awardId])
  @@index([redeemedAt])
  @@index([status])
}

// -----------------------------------------------------------------------------
// Session Templates (Recurring Sessions)
// -----------------------------------------------------------------------------

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model SessionTemplate {
  id            String      @id @default(cuid())
  tutorId       String
  centreId      String
  dayOfWeek     DayOfWeek
  startTime     String      // "16:00" stored as HH:mm
  endTime       String      // "17:00"
  sessionMode   SessionMode
  maxCapacity   Int         @default(15)
  title         String?
  description   String?     @db.Text
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  tutor         User        @relation("TutorTemplates", fields: [tutorId], references: [id])
  centre        Center      @relation("CentreTemplates", fields: [centreId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@index([centreId])
  @@index([dayOfWeek])
  @@index([isActive])
}

enum RecurrenceType {
  NONE
  WEEKLY
}

model ClassScheduleRule {
  id          String         @id @default(cuid())
  centreId    String
  classId     String

  recurrence  RecurrenceType @default(WEEKLY)
  startDate   DateTime
  endDate     DateTime?
  // 0=Sun..6=Sat
  daysOfWeek  Int[]          // e.g. [1,3] for Mon/Wed
  startTime   String         // "16:30" local time
  durationMin Int            @default(60)
  timezone    String         @default("Australia/Sydney")

  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  class  ClassCohort @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId, isActive])
  @@index([centreId])
}

model WhiteboardState {
  id         String   @id @default(cuid())
  centreId   String
  centre     Center   @relation(fields: [centreId], references: [id], onDelete: Cascade)
  sessionId  String
  studentId  String
  exerciseId String
  stateJson  Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User    @relation("StudentWhiteboards", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId, exerciseId])
  @@index([sessionId])
  @@index([studentId, exerciseId])
  @@index([centreId])
}

model ActivityLog {
  id              String   @id @default(cuid())
  centreId        String
  centre          Center   @relation(fields: [centreId], references: [id], onDelete: Cascade)
  enrollmentId    String
  studentId       String
  activityType    String   // EXERCISE_START, EXERCISE_COMPLETE, QUESTION_ANSWER, WHITEBOARD_SAVE, PAGE_VIEW
  activityId      String?  // ID of exercise, question etc
  details         Json?
  timestamp       DateTime @default(now())

  enrollment      StudentSessionEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student         User                     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([timestamp])
  @@index([centreId])
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Notification {
  id          String               @id @default(cuid())
  type        String               // e.g., "SYSTEM", "ACADEMIC", "FINANCIAL", "TICKET"
  title       String
  message     String               @db.Text
  link        String?              // Optional link to action
  priority    NotificationPriority @default(MEDIUM)
  read        Boolean              @default(false)
  data        Json?                // Additional context

  userId      String
  user        User                 @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model SessionPresenceLog {
  id              String   @id @default(cuid())
  centreId        String
  centre          Center   @relation(fields: [centreId], references: [id], onDelete: Cascade)
  sessionId       String
  studentId       String
  enrollmentId    String
  event           String   // JOIN, LEAVE, HEARTBEAT, DISCONNECT, RECONNECT
  timestamp       DateTime @default(now())

  session         Session                  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student         User                     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  enrollment      StudentSessionEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([sessionId, studentId])
  @@index([enrollmentId])
  @@index([timestamp])
  @@index([centreId])
}

// Video Conferencing Models - Phase 1 In-Built Video Implementation

enum VideoProvider {
  DAILY    // Daily.co (primary implementation)
  JITSI    // Jitsi Meet (future option)
  CUSTOM   // Custom WebRTC implementation
  NONE     // No video (fallback to external links)
}

enum RecordingStatus {
  PROCESSING  // Recording is being processed
  READY       // Recording is ready for viewing
  FAILED      // Recording failed
  DELETED     // Recording has been deleted
}

// Video Participant - tracks individual participant in video session
model VideoParticipant {
  id                 String   @id @default(cuid())
  sessionId          String
  userId             String
  participantId      String   // Daily.co participant ID
  joinedAt           DateTime @default(now())
  leftAt             DateTime?
  durationMs         Int      @default(0) // Duration in milliseconds
  videoEnabled       Boolean  @default(true)
  audioEnabled       Boolean  @default(true)
  screenShareEnabled Boolean  @default(false)
  
  // Relations
  session            Session  @relation("VideoParticipants", fields: [sessionId], references: [id], onDelete: Cascade)
  user               User     @relation("UserVideoParticipants", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([userId])
  @@index([participantId])
  @@index([sessionId, userId])
}

// Video Recording - tracks session recordings
model VideoRecording {
  id               String          @id @default(cuid())
  sessionId        String
  recordingId      String          @unique // Daily.co recording ID
  startedAt        DateTime        @default(now())
  endedAt          DateTime?
  durationMs       Int?            // Duration in milliseconds
  downloadUrl      String?         // URL to download recording
  streamUrl        String?         // URL to stream recording
  transcriptionUrl String?         // URL to transcription file
  status           RecordingStatus @default(PROCESSING)
  centreId         String
  
  // Relations
  session          Session         @relation("VideoRecordings", fields: [sessionId], references: [id], onDelete: Cascade)
  centre           Center          @relation("CentreVideoRecordings", fields: [centreId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([status])
  @@index([centreId])
  @@index([recordingId])
}
