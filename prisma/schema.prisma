// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant support - Centers/Tenants
model Center {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  region      String?  // Region for multi-region support
  branding    Json?    // Branding settings (logo, colors, etc.)
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  courses     Course[]
  financialTransactions FinancialTransaction[]
  
  // Phase 1 relationships
  auditEvents     AuditEvent[]       @relation("AuditEvents")
  approvalRequests ApprovalRequest[] @relation("ApprovalRequests")
  classes         ClassCohort[]      @relation("Classes")
  tickets         Ticket[]           @relation("Tickets")
  slaConfigs      SLAConfig[]        @relation("SLAConfigs")
  feePlans        FeePlan[]          @relation("FeePlans")
  studentAccounts StudentAccount[]   @relation("StudentAccounts")
  invoices        Invoice[]          @relation("Invoices")
}

// User model with role-based access
enum Role {
  SUPER_ADMIN      // Full system access across all centers
  CENTER_ADMIN     // Admin for a specific center
  CENTER_SUPERVISOR // Supervisor for a specific center
  FINANCE_ADMIN    // Financial administrator for a center
  TEACHER          // Teacher/Tutor role
  PARENT           // Parent/Guardian role
  STUDENT          // Student role
}

enum AgeTier {
  TIER1  // Ages 5-8 (playful, large touch targets)
  TIER2  // Ages 9-13 (structured, medium density)
  TIER3  // Ages 14+/Adult (professional, standard)
}

enum ThemePreference {
  LIGHT  // Light mode (white surfaces)
  GRAY   // Gray mode (soft gray surfaces)
  DARK   // Dark mode (dark surfaces)
}

enum SessionMode {
  ONLINE    // Online/virtual session
  PHYSICAL  // Physical/in-person session
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String    // Hashed password
  role          Role      @default(STUDENT)
  avatar        String?
  bio           String?
  languagePreference String @default("en") // Language preference
  accessibilitySettings Json? // Accessibility settings (font size, contrast, etc.)
  specialNeeds  Json?     // Special needs indicators (Autism, ADHD, etc.)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NEW: Age-tier system (nullable with defaults)
  dateOfBirth       DateTime?
  ageTier           AgeTier   @default(TIER3)
  
  // NEW: Theme preference (nullable with default)
  themePreference   ThemePreference @default(LIGHT)

  // Multi-tenant relationship
  centerId      String
  center        Center    @relation(fields: [centerId], references: [id], onDelete: Cascade)
  
  // Teaching relationships
  taughtCourses Course[]  @relation("TeacherCourses")
  
  // Student relationships
  enrollments   Enrollment[]
  progress      Progress[]
  
  // Academic profile
  academicProfile AcademicProfile?
  
  // Gamification
  gamificationProfile GamificationProfile?
  xpTransactions    XPTransaction[]
  badgeAwards       BadgeAward[]
  streaks           Streak[]
  leaderboardOptIn  LeaderboardOptIn?

  // Financial transactions
  financialTransactions FinancialTransaction[]
  
  // Session attendance
  sessionAttendance SessionAttendance[]
  
  // NEW: Student session enrollments (for personalized session content)
  studentSessionEnrollments StudentSessionEnrollment[] @relation("StudentEnrollments")

  // Parent-Student relationships
  parentId      String?
  parent        User?    @relation("ParentStudents", fields: [parentId], references: [id], onDelete: SetNull)
  children      User[]   @relation("ParentStudents")
  
  // Phase 1 relationships
  requestedApprovals ApprovalRequest[] @relation("RequestedApprovals")
  approvedApprovals  ApprovalRequest[] @relation("ApprovedApprovals")
  taughtClasses      ClassCohort[]     @relation("TaughtClasses")
  classMemberships   ClassMembership[] @relation("ClassMemberships")
  attendanceRecords  AttendanceRecord[] @relation("AttendanceRecords")
  markedAttendance   AttendanceRecord[] @relation("MarkedAttendance")
  catchUpPackages    CatchUpPackage[]   @relation("CatchUpPackages")
  createdTickets     Ticket[]           @relation("CreatedTickets")
  assignedTickets    Ticket[]           @relation("AssignedTickets")
  ticketComments     TicketComment[]    @relation("TicketComments")
  ticketAttachments  TicketAttachment[] @relation("TicketAttachments")
  studentAccount     StudentAccount?    @relation("StudentAccount")
  recordedPayments   Payment[]          @relation("RecordedPayments")
  requestedRefunds   Refund[]           @relation("RequestedRefunds")
  approvedRefunds    Refund[]           @relation("ApprovedRefunds")

  @@index([centerId])
  @@index([email])
  @@index([parentId])
}

// Course model
model Course {
  id          String   @id @default(cuid())
  title       String
  slug        String
  description String?
  thumbnail   String?
  status      CourseStatus @default(DRAFT)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Multi-tenant relationship
  centerId    String
  center      Center   @relation(fields: [centerId], references: [id], onDelete: Cascade)
  
  // Teacher relationship
  teacherId   String
  teacher     User     @relation("TeacherCourses", fields: [teacherId], references: [id])
  
  // Course hierarchy
  modules     Module[]
  enrollments Enrollment[]
  
  // NEW: Session enrollments (students working on this course in sessions)
  sessionEnrollments StudentSessionEnrollment[] @relation("SessionEnrollments")
  
  @@unique([centerId, slug])
  @@index([centerId])
  @@index([teacherId])
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Module model - course hierarchy
model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  lessons     Lesson[]
  
  @@index([courseId])
}

// Lesson model - module hierarchy
model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  contents    Content[]
  progress    Progress[]
  
  // NEW: Session enrollments (students working on this lesson in sessions)
  sessionEnrollments StudentSessionEnrollment[] @relation("SessionEnrollments")
  
  @@index([moduleId])
}

// Content model - supports multiple content types
enum ContentType {
  DOCUMENT  // PDF, Word, etc.
  VIDEO     // MP4, WebM, etc.
  SCORM     // SCORM packages
  XAPI      // xAPI/TinCan content
  EMBED     // Embedded content (YouTube, etc.)
  QUIZ      // Quiz/Assessment
}

model Content {
  id          String      @id @default(cuid())
  title       String
  type        ContentType
  url         String      // File URL or embed URL
  duration    Int?        // Duration in minutes for videos
  fileSize    Int?        // File size in bytes
  metadata    Json?       // Additional metadata for SCORM/xAPI
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  lessonId    String
  lesson      Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@index([lessonId])
}

// Enrollment model - student course enrollment
model Enrollment {
  id            String   @id @default(cuid())
  enrolledAt    DateTime @default(now())
  completedAt   DateTime?
  progress      Float    @default(0) // Percentage 0-100
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courseId      String
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Tutor allocation
  tutorId       String?  // Assigned tutor for this enrollment
  
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([tutorId])
}

// Progress tracking model
model Progress {
  id            String   @id @default(cuid())
  completed     Boolean  @default(false)
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  timeSpent     Int      @default(0) // Time spent in minutes
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lessonId      String
  lesson        Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

// Academic Profile - tracks student academic age and performance
model AcademicProfile {
  id                  String   @id @default(cuid())
  chronologicalAge    Float?   // Age in years
  readingAge          Float?   // Reading age in years
  numeracyAge         Float?   // Numeracy/Math age in years
  comprehensionIndex  Float?   // Comprehension level (0-100)
  writingProficiency  Float?   // Writing proficiency level (0-100)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// Financial Transaction - tracks payments and billing
enum TransactionType {
  STUDENT_FEE      // Fee charged to student
  STUDENT_PAYMENT  // Payment received from student
  TUTOR_PAYMENT    // Payment to tutor
  OPERATIONAL_COST // Other operational costs
  REFUND           // Refund to student
}

model FinancialTransaction {
  id          String          @id @default(cuid())
  amount      Float
  type        TransactionType
  description String?
  status      String          @default("pending") // pending, completed, failed
  metadata    Json?           // Additional transaction details
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  centerId    String
  center      Center          @relation(fields: [centerId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([centerId])
  @@index([type])
  @@index([createdAt])
}

// Session - Live classroom sessions (Teams/Zoom integration)
// MAJOR PIVOT: Sessions now support multiple students working on different courses/levels
// at the same time with the same tutor
enum SessionProvider {
  TEAMS
  ZOOM
  CHIME
  OTHER
}

enum SessionStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

model Session {
  id              String         @id @default(cuid())
  title           String
  description     String?
  provider        SessionProvider
  providerMeetingId String?      // Meeting ID from provider
  joinUrl         String?        // Join URL for the session
  startTime       DateTime
  endTime         DateTime?
  status          SessionStatus  @default(SCHEDULED)
  recordingUrl    String?        // Recording URL after session
  transcriptUrl   String?        // Transcript URL
  metadata        Json?          // Provider-specific metadata
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Session mode and location
  sessionMode     SessionMode    @default(ONLINE)
  meetingLink     String?        // Manual meeting link for ONLINE mode
  physicalLocation String?       // Location description for PHYSICAL mode
  
  // REMOVED: lessonId - no longer tied to a single lesson
  // Sessions now support multiple students on different content
  
  tutorId         String         // Required - every session has a tutor
  
  // Phase 1: Link to ClassCohort (optional, for group management)
  classId         String?
  class           ClassCohort?   @relation("ClassSessions", fields: [classId], references: [id])
  
  // NEW: Student enrollments with individual course/lesson assignments
  studentEnrollments StudentSessionEnrollment[]
  
  attendance      SessionAttendance[]
  attendanceRecords AttendanceRecord[] @relation("AttendanceRecords")
  catchUpPackages CatchUpPackage[]   @relation("CatchUpPackages")
  
  @@index([tutorId])
  @@index([startTime])
  @@index([status])
  @@index([classId])
}

// NEW: Student Session Enrollment
// Tracks individual student participation in a session with their specific course/lesson
model StudentSessionEnrollment {
  id              String   @id @default(cuid())
  
  sessionId       String
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         User     @relation("StudentEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  
  // Each student can work on different content
  courseId        String?  // Optional: track which course
  course          Course?  @relation("SessionEnrollments", fields: [courseId], references: [id], onDelete: SetNull)
  
  lessonId        String?  // Optional: track which lesson
  lesson          Lesson?  @relation("SessionEnrollments", fields: [lessonId], references: [id], onDelete: SetNull)
  
  // Custom content for this student in this session
  exerciseContent Json?    // Exercises/activities assigned to this student
  assessmentData  Json?    // Assessment results/answers for this student
  
  // Student's progress in this session
  completed       Boolean  @default(false)
  notes           String?  // Tutor notes specific to this student's session
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([courseId])
  @@index([lessonId])
}

// Session Attendance - track student attendance in live sessions
model SessionAttendance {
  id          String   @id @default(cuid())
  joinedAt    DateTime?
  leftAt      DateTime?
  attended    Boolean  @default(false)
  
  sessionId   String
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

// Gamification Profile - XP, levels, and achievements
model GamificationProfile {
  id              String   @id @default(cuid())
  xp              Int      @default(0)
  level           Int      @default(1)
  streak          Int      @default(0) // Consecutive days of activity
  lastActivityAt  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // NEW: Additional tracking (nullable - won't break existing)
  totalXP         Int?     @default(0)  // Lifetime XP
  nextLevelXP     Int?     @default(100)

  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  badges          Badge[]
  achievements    Achievement[]

  @@index([userId])
  @@index([level])
  @@index([xp])
}

// Badge - Achievement badges
enum BadgeType {
  COMPLETION      // Course/lesson completion
  STREAK          // Activity streak
  MASTERY         // Subject mastery
  PARTICIPATION   // Active participation
  SPECIAL         // Special achievements
}

model Badge {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        BadgeType
  iconUrl     String?
  earnedAt    DateTime @default(now())
  
  profileId   String
  profile     GamificationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId])
  @@index([type])
}

// Achievement - Milestones and accomplishments
model Achievement {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String   // e.g., "reading", "math", "attendance"
  value       Float?   // Achievement value (e.g., 100% completion)
  earnedAt    DateTime @default(now())

  profileId   String
  profile     GamificationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([category])
}

// ============================================================================
// ENHANCED GAMIFICATION MODELS - XP Transactions, Badges, Streaks
// ============================================================================

// XP Transaction Log
model XPTransaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Int      // XP earned
  source      XPSource
  sourceId    String?  // ID of the activity
  description String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([source])
}

enum XPSource {
  LESSON_COMPLETION
  HOMEWORK_SUBMISSION
  HOMEWORK_ONTIME
  SESSION_ATTENDANCE
  QUIZ_COMPLETION
  QUIZ_PERFECT
  READING_ACTIVITY
  HELPING_PEER
  STREAK_MILESTONE
}

// Badge Definitions (reusable templates)
model BadgeDefinition {
  id          String     @id @default(cuid())
  name        String     @unique
  description String
  category    BadgeCategory
  tier        BadgeTier
  iconUrl     String?
  xpValue     Int        @default(0)
  criteria    Json       // Unlock conditions
  isActive    Boolean    @default(true)

  awards      BadgeAward[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([category])
  @@index([tier])
}

enum BadgeCategory {
  COMPLETION
  STREAK
  MASTERY
  SOCIAL
  SPECIAL
}

enum BadgeTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

// Badge Awards (to users)
model BadgeAward {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId         String
  badge           BadgeDefinition  @relation(fields: [badgeId], references: [id])
  awardedAt       DateTime         @default(now())

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([awardedAt])
}

// Streak Tracking
model Streak {
  id              String     @id @default(cuid())
  userId          String     @unique
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            StreakType
  currentStreak   Int        @default(0)
  longestStreak   Int        @default(0)
  lastActivityAt  DateTime   @default(now())
  freezesAvailable Int       @default(1)

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([userId])
  @@index([type])
}

enum StreakType {
  ATTENDANCE
  HOMEWORK
  READING
  LOGIN
}

// Leaderboard Opt-In
model LeaderboardOptIn {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled   Boolean  @default(false)
  scope     String   @default("class") // "class", "centre", "global"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// PHASE 1 MODELS - Governance, Academic, Operations, Finance
// ============================================================================

// Governance Domain - Audit Logging
enum AuditAction {
  CREATE
  UPDATE
  DELETE
  APPROVE
  REJECT
  ESCALATE
}

model AuditEvent {
  id            String      @id @default(cuid())
  userId        String      // Actor who performed the action
  userName      String      // Denormalized for reporting
  userRole      Role        // Role at time of action
  
  action        AuditAction
  resourceType  String      // e.g., "Refund", "Invoice", "Ticket"
  resourceId    String      // ID of the affected resource
  
  beforeState   Json?       // State before the action (UPDATE/DELETE)
  afterState    Json?       // State after the action (CREATE/UPDATE)
  
  centreId      String      // Multi-tenancy
  centre        Center      @relation("AuditEvents", fields: [centreId], references: [id])
  
  ipAddress     String?     // Client IP address
  metadata      Json?       // Additional context
  
  createdAt     DateTime    @default(now())
  
  @@index([centreId])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@index([createdAt])
}

// Governance Domain - Approval Workflow
enum ApprovalType {
  REFUND
  TUTOR_OVERRIDE
  PAYROLL_EXCEPTION
  FEE_WAIVER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

model ApprovalRequest {
  id              String          @id @default(cuid())
  type            ApprovalType
  
  requestedById   String
  requestedBy     User            @relation("RequestedApprovals", fields: [requestedById], references: [id])
  requestedByName String          // Denormalized
  
  status          ApprovalStatus  @default(PENDING)
  
  approvedById    String?
  approvedBy      User?           @relation("ApprovedApprovals", fields: [approvedById], references: [id])
  approvedByName  String?         // Denormalized
  approvedAt      DateTime?
  
  resourceType    String          // e.g., "Refund"
  resourceId      String          // e.g., refund_123
  
  metadata        Json            // Type-specific data (amount, reason, etc.)
  comment         String?         // Approver's comment
  
  centreId        String
  centre          Center          @relation("ApprovalRequests", fields: [centreId], references: [id])
  
  expiresAt       DateTime        // Auto-reject if not actioned
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  refunds         Refund[]
  
  @@index([centreId, status])
  @@index([requestedById])
  @@index([approvedById])
  @@index([type])
  @@index([expiresAt])
}

// Academic Domain - Classes/Cohorts
enum ClassStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model ClassCohort {
  id                String            @id @default(cuid())
  name              String            // "Math Grade 5 - Spring 2026"
  subject           String            // "Mathematics"
  description       String?

  startDate         DateTime
  endDate           DateTime?  // Optional - class might be ongoing

  maxCapacity       Int               @default(20)
  currentEnrollment Int               @default(0)
  
  status            ClassStatus       @default(ACTIVE)
  
  teacherId         String
  teacher           User              @relation("TaughtClasses", fields: [teacherId], references: [id])
  
  centreId          String
  centre            Center            @relation("Classes", fields: [centreId], references: [id])
  
  members           ClassMembership[]
  sessions          Session[]         @relation("ClassSessions")
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([centreId])
  @@index([teacherId])
  @@index([status])
  @@index([startDate, endDate])
}

// Academic Domain - Class Membership
enum MembershipStatus {
  ACTIVE
  DROPPED
  COMPLETED
}

model ClassMembership {
  id          String           @id @default(cuid())
  
  classId     String
  class       ClassCohort      @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     User             @relation("ClassMemberships", fields: [studentId], references: [id], onDelete: Cascade)
  
  status      MembershipStatus @default(ACTIVE)
  joinedAt    DateTime         @default(now())
  leftAt      DateTime?
  
  centreId    String           // Denormalized for efficient queries
  
  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@index([centreId, status])
}

// Academic Domain - Attendance Records
enum AttendanceStatus {
  PENDING
  PRESENT
  ABSENT
  LATE
  EXCUSED
  CANCELLED
}

model AttendanceRecord {
  id          String            @id @default(cuid())
  
  sessionId   String
  session     Session           @relation("AttendanceRecords", fields: [sessionId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     User              @relation("AttendanceRecords", fields: [studentId], references: [id], onDelete: Cascade)
  
  status      AttendanceStatus  @default(PENDING)
  
  markedAt    DateTime?
  markedById  String?
  markedBy    User?             @relation("MarkedAttendance", fields: [markedById], references: [id])
  
  notes       String?
  
  centreId    String            // Denormalized
  
  catchUpPackage CatchUpPackage?
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([centreId, sessionId])
  @@index([status])
}

// Academic Domain - Catch-Up Packages
enum CatchUpStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

model CatchUpPackage {
  id          String        @id @default(cuid())
  
  studentId   String
  student     User          @relation("CatchUpPackages", fields: [studentId], references: [id], onDelete: Cascade)
  
  sessionId   String
  session     Session       @relation("CatchUpPackages", fields: [sessionId], references: [id])
  
  attendanceId String       @unique
  attendance  AttendanceRecord @relation(fields: [attendanceId], references: [id])
  
  status      CatchUpStatus @default(PENDING)
  
  dueDate     DateTime      // Auto-calculated: missedDate + 7 days
  completedAt DateTime?
  
  resources   Json          // Array of { type, url, title, duration }
  notes       String?
  
  centreId    String
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([studentId, status])
  @@index([centreId])
  @@index([dueDate])
}

// Operations Domain - Tickets
enum TicketType {
  IT
  INVENTORY
  COMPLAINT
  MAINTENANCE
  GENERAL
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  ESCALATED
}

model Ticket {
  id            String          @id @default(cuid())
  ticketNumber  String          @unique // TICK-2026-0001
  
  type          TicketType
  priority      TicketPriority
  status        TicketStatus    @default(OPEN)
  
  subject       String          // 5-200 chars
  description   String          @db.Text // 10-2000 chars
  
  createdById   String
  createdBy     User            @relation("CreatedTickets", fields: [createdById], references: [id])
  
  assignedToId  String?
  assignedTo    User?           @relation("AssignedTickets", fields: [assignedToId], references: [id])
  
  resolution    String?         @db.Text // Filled when RESOLVED/CLOSED
  
  slaDueAt      DateTime        // Auto-calculated from SLAConfig
  isOverdue     Boolean         @default(false)
  
  centreId      String
  centre        Center          @relation("Tickets", fields: [centreId], references: [id])
  
  comments      TicketComment[]
  attachments   TicketAttachment[]
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([centreId, status])
  @@index([createdById])
  @@index([assignedToId])
  @@index([ticketNumber])
  @@index([slaDueAt])
  @@index([centreId, status, slaDueAt])
}

model TicketComment {
  id          String    @id @default(cuid())
  
  ticketId    String
  ticket      Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User      @relation("TicketComments", fields: [userId], references: [id])
  userName    String    // Denormalized
  
  text        String    @db.Text
  isInternal  Boolean   @default(false) // Internal notes vs public comments
  isSystem    Boolean   @default(false) // System-generated
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([ticketId])
  @@index([userId])
}

model TicketAttachment {
  id          String    @id @default(cuid())
  
  ticketId    String
  ticket      Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  filename    String
  url         String    // Cloud storage URL
  mimeType    String
  size        Int       // Bytes
  
  uploadedById String
  uploadedBy  User      @relation("TicketAttachments", fields: [uploadedById], references: [id])
  
  createdAt   DateTime  @default(now())
  
  @@index([ticketId])
}

model SLAConfig {
  id          String         @id @default(cuid())
  
  ticketType  TicketType
  priority    TicketPriority
  
  responseTimeHours   Int    // Time to first response
  resolutionTimeHours Int    // Time to resolution
  
  centreId    String
  centre      Center         @relation("SLAConfigs", fields: [centreId], references: [id])
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@unique([centreId, ticketType, priority])
  @@index([centreId])
}

// Finance Domain - Fee Plans
enum BillingFrequency {
  ONE_TIME
  WEEKLY
  MONTHLY
  TERM
  ANNUAL
}

enum FeePlanStatus {
  ACTIVE
  ARCHIVED
}

model FeePlan {
  id          String          @id @default(cuid())
  name        String
  description String?
  
  amount      Decimal         @db.Decimal(10, 2)
  currency    String          @default("USD")
  
  frequency   BillingFrequency
  
  // Optional filters
  applicableCourses Json?     // Array of course IDs
  applicableClasses Json?     // Array of class IDs
  
  status      FeePlanStatus   @default(ACTIVE)
  
  centreId    String
  centre      Center          @relation("FeePlans", fields: [centreId], references: [id])
  
  invoices    Invoice[]
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([centreId, status])
}

// Finance Domain - Student Accounts
model StudentAccount {
  id          String    @id @default(cuid())
  
  studentId   String    @unique
  student     User      @relation("StudentAccount", fields: [studentId], references: [id], onDelete: Cascade)
  
  totalBilled    Decimal @db.Decimal(10, 2) @default(0)
  totalPaid      Decimal @db.Decimal(10, 2) @default(0)
  totalRefunded  Decimal @db.Decimal(10, 2) @default(0)
  balance        Decimal @db.Decimal(10, 2) @default(0) // Calculated
  
  centreId    String
  centre      Center    @relation("StudentAccounts", fields: [centreId], references: [id])
  
  invoices    Invoice[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([centreId])
  @@index([studentId])
}

// Finance Domain - Invoices
enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id            String         @id @default(cuid())
  invoiceNumber String         @unique // INV-2026-0001
  
  studentAccountId String
  studentAccount StudentAccount @relation(fields: [studentAccountId], references: [id])
  
  studentId     String         // Denormalized for queries
  
  feePlanId     String?
  feePlan       FeePlan?       @relation(fields: [feePlanId], references: [id])
  
  issueDate     DateTime       @default(now())
  dueDate       DateTime
  sentAt        DateTime?
  
  status        InvoiceStatus  @default(DRAFT)
  
  subtotal      Decimal        @db.Decimal(10, 2)
  tax           Decimal        @db.Decimal(10, 2) @default(0)
  total         Decimal        @db.Decimal(10, 2)
  
  paidAmount    Decimal        @db.Decimal(10, 2) @default(0)
  balance       Decimal        @db.Decimal(10, 2) // Calculated: total - paidAmount
  
  notes         String?        @db.Text
  
  centreId      String
  centre        Center         @relation("Invoices", fields: [centreId], references: [id])
  
  lineItems     InvoiceLine[]
  payments      Payment[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@index([centreId, status])
  @@index([studentId])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@index([centreId, status, dueDate])
}

model InvoiceLine {
  id          String    @id @default(cuid())
  
  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Int       @default(1)
  unitPrice   Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(10, 2) // quantity * unitPrice
  
  order       Int       @default(0) // Display order
  
  createdAt   DateTime  @default(now())
  
  @@index([invoiceId])
}

// Finance Domain - Payments
enum PaymentMethod {
  CASH
  CHECK
  BANK_TRANSFER
  CARD
  OTHER
}

model Payment {
  id          String        @id @default(cuid())
  
  invoiceId   String
  invoice     Invoice       @relation(fields: [invoiceId], references: [id])
  
  amount      Decimal       @db.Decimal(10, 2)
  
  method      PaymentMethod
  paymentDate DateTime
  reference   String?       // Check number, transaction ID, etc.
  
  notes       String?       @db.Text
  
  recordedById String
  recordedBy  User          @relation("RecordedPayments", fields: [recordedById], references: [id])
  
  centreId    String
  
  refunds     Refund[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([invoiceId])
  @@index([centreId])
  @@index([paymentDate])
}

// Finance Domain - Refunds
enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

model Refund {
  id          String        @id @default(cuid())
  refundNumber String       @unique // REF-2026-0001
  
  paymentId   String
  payment     Payment       @relation(fields: [paymentId], references: [id])
  
  amount      Decimal       @db.Decimal(10, 2)
  reason      String        @db.Text
  
  status      RefundStatus  @default(PENDING)
  
  refundMethod String?      // ORIGINAL_METHOD, BANK_TRANSFER, etc.
  
  processedDate DateTime?
  processedReference String?
  
  requestedById String
  requestedBy User          @relation("RequestedRefunds", fields: [requestedById], references: [id])
  
  approvedById String?
  approvedBy  User?         @relation("ApprovedRefunds", fields: [approvedById], references: [id])
  approvedAt  DateTime?
  
  approvalRequestId String?  @unique
  approvalRequest ApprovalRequest? @relation(fields: [approvalRequestId], references: [id])
  
  centreId    String
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([centreId, status])
  @@index([paymentId])
  @@index([refundNumber])
}
